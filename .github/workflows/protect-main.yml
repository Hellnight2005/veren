name: Protect Main Branch

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  protect-main:
    runs-on: ubuntu-latest
    name: Enforce PR Target Branch
    
    steps:
      - name: Check PR Target Branch
        if: github.base_ref == 'main'
        run: |
          echo "‚ùå ERROR: Direct PRs to 'main' are not allowed!"
          echo "üìå Please create a PR against the 'test' branch instead."
          echo ""
          echo "How to fix:"
          echo "1. Close this PR"
          echo "2. Create a new PR targeting 'test' branch instead"
          echo ""
          echo "Reason: All changes must go through 'test' branch first for testing before merging to 'main'."
          exit 1

      - name: Check PR Branch Naming Convention
        if: github.head_ref != null
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Allowed patterns: feature/issue-*, fix/issue-*, docs/issue-*, etc.
          if [[ ! $BRANCH_NAME =~ ^(feature|fix|docs|refactor|perf|test|chore)/issue-[0-9]+-[a-z0-9-]+$ ]]; then
            echo "‚ö†Ô∏è  WARNING: Branch name '$BRANCH_NAME' doesn't follow convention"
            echo ""
            echo "Expected format: <type>/issue-<number>-<description>"
            echo "Examples:"
            echo "  - feature/issue-45-add-rate-limiting"
            echo "  - fix/issue-78-handle-null-env"
            echo "  - docs/issue-50-update-api-docs"
            echo ""
            echo "While this is a warning, please follow the convention in the future!"
          fi

  validate-pr-content:
    runs-on: ubuntu-latest
    name: Validate PR Content
    
    steps:
      - uses: actions/checkout@v4

      - name: Check for Required PR Template Fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            const requiredSections = [
              { name: 'Issue', pattern: /##\s+Issue\s*\n\s*Closes\s+#\d+/i },
              { name: 'Description', pattern: /##\s+Description\s*\n/i },
              { name: 'Type of Change', pattern: /##\s+Type\s+of\s+Change/i },
              { name: 'Checklist', pattern: /##\s+Checklist/i }
            ];
            
            const missing = requiredSections.filter(section => !section.pattern.test(body));
            
            if (missing.length > 0) {
              const missingNames = missing.map(s => `- ${s.name}`).join('\n');
              github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ùå Please complete the PR template with the following sections:\n\n${missingNames}\n\nRefer to the PR template for the required format.`
              });
              throw new Error('PR template is incomplete');
            }
            
            console.log('‚úÖ PR template validation passed');

  assign-check:
    runs-on: ubuntu-latest
    name: Verify Assignment through /assign Command
    
    steps:
      - name: Check if PR is assigned
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            if (pr.assignees && pr.assignees.length > 0) {
              github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ö†Ô∏è **Note:** Assignment should only be done through the related issue using the \`/assign\` command. Please make sure the linked issue is properly assigned.`
              });
            }
